# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 1. HTTP + storage. Отчёт
### Нагрузочное тестирование с помощью wrk2
Произведём нагрузочное тестирование с помощью wrk2 
в течении одной минуты, используя одно активное соединение,
один поток и поддерживая поток запросов на уровне 1000 запросов/с.

#### PUT-запросами:
```
$ wrk2 -c1 -t1 -d1m -R1000 -L -s 2021-highload-dht/src/main/resources/wrk/put.lua http://localhost:8080
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.213ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.21ms  694.47us  22.62ms   86.39%
    Req/Sec     1.05k    98.86     3.10k    84.43%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.17ms
 75.000%    1.51ms
 90.000%    1.79ms
 99.000%    2.49ms
 99.900%    9.58ms
 99.990%   20.75ms
 99.999%   22.64ms
100.000%   22.64ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.123     0.000000            1         1.00
       0.592     0.100000         5000         1.11
       0.758     0.200000        10035         1.25
       0.902     0.300000        15026         1.43
       1.042     0.400000        20027         1.67
       1.170     0.500000        25033         2.00
       1.228     0.550000        27505         2.22
       1.295     0.600000        30012         2.50
       1.365     0.650000        32506         2.86
       1.436     0.700000        34997         3.33
       1.509     0.750000        37511         4.00
       1.548     0.775000        38757         4.44
       1.585     0.800000        40001         5.00
       1.626     0.825000        41252         5.71
       1.672     0.850000        42505         6.67
       1.722     0.875000        43757         8.00
       1.750     0.887500        44374         8.89
       1.786     0.900000        45002        10.00
       1.827     0.912500        45635        11.43
       1.871     0.925000        46260        13.33
       1.924     0.937500        46873        16.00
       1.954     0.943750        47187        17.78
       1.989     0.950000        47496        20.00
       2.025     0.956250        47811        22.86
       2.081     0.962500        48130        26.67
       2.139     0.968750        48440        32.00
       2.175     0.971875        48590        35.56
       2.213     0.975000        48749        40.00
       2.259     0.978125        48903        45.71
       2.311     0.981250        49061        53.33
       2.357     0.984375        49221        64.00
       2.385     0.985938        49294        71.11
       2.423     0.987500        49371        80.00
       2.469     0.989062        49449        91.43
       2.519     0.990625        49528       106.67
       2.589     0.992188        49605       128.00
       2.629     0.992969        49645       142.22
       2.727     0.993750        49683       160.00
       2.931     0.994531        49722       182.86
       3.253     0.995313        49761       213.33
       3.901     0.996094        49800       256.00
       4.191     0.996484        49820       284.44
       4.451     0.996875        49839       320.00
       5.023     0.997266        49859       365.71
       5.583     0.997656        49878       426.67
       6.055     0.998047        49898       512.00
       6.519     0.998242        49908       568.89
       6.927     0.998437        49917       640.00
       7.819     0.998633        49928       731.43
       8.655     0.998828        49937       853.33
      10.031     0.999023        49947      1024.00
      10.423     0.999121        49952      1137.78
      11.031     0.999219        49956      1280.00
      11.599     0.999316        49961      1462.86
      12.303     0.999414        49966      1706.67
      13.047     0.999512        49971      2048.00
      13.727     0.999561        49974      2275.56
      14.615     0.999609        49976      2560.00
      15.503     0.999658        49978      2925.71
      16.863     0.999707        49981      3413.33
      17.759     0.999756        49983      4096.00
      18.559     0.999780        49985      4551.11
      19.055     0.999805        49986      5120.00
      19.391     0.999829        49987      5851.43
      19.935     0.999854        49988      6826.67
      20.207     0.999878        49989      8192.00
      20.751     0.999890        49990      9102.22
      21.023     0.999902        49991     10240.00
      21.023     0.999915        49991     11702.86
      21.599     0.999927        49992     13653.33
      21.599     0.999939        49992     16384.00
      21.855     0.999945        49993     18204.44
      21.855     0.999951        49993     20480.00
      21.855     0.999957        49993     23405.71
      22.367     0.999963        49994     27306.67
      22.367     0.999969        49994     32768.00
      22.367     0.999973        49994     36408.89
      22.367     0.999976        49994     40960.00
      22.367     0.999979        49994     46811.43
      22.639     0.999982        49995     54613.33
      22.639     1.000000        49995          inf
#[Mean    =        1.208, StdDeviation   =        0.694]
#[Max     =       22.624, Total count    =        49995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  60000 requests in 1.00m, 3.83MB read
Requests/sec:    999.98
Transfer/sec:     65.43KB
```

По результатам нагрузочного тестирования
видно, что 75% приходящих запросов обрабатываются 
в промежуток до 1.51мс, 
99% — до 2.49мс, 99,999% — до 22.64,
максимальное время обрабоки запроса до 22.64мс.

#### GET запросами:
```
$ wrk2 -c1 -t1 -d1m -R1000 -L -s 2021-highload-dht/src/main/resources/wrk/get.lua http://localhost:8080
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.257ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.24ms  523.25us  12.03ms   69.62%
    Req/Sec     1.05k    92.28     1.50k    80.00%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.22ms
 75.000%    1.59ms
 90.000%    1.89ms
 99.000%    2.48ms
 99.900%    3.08ms
 99.990%    7.97ms
 99.999%   12.04ms
100.000%   12.04ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.113     0.000000            1         1.00
       0.579     0.100000         5013         1.11
       0.784     0.200000        10013         1.25
       0.938     0.300000        15004         1.43
       1.086     0.400000        20007         1.67
       1.222     0.500000        25027         2.00
       1.288     0.550000        27526         2.22
       1.357     0.600000        30024         2.50
       1.430     0.650000        32521         2.86
       1.509     0.700000        35012         3.33
       1.590     0.750000        37496         4.00
       1.628     0.775000        38759         4.44
       1.670     0.800000        40015         5.00
       1.714     0.825000        41264         5.71
       1.759     0.850000        42506         6.67
       1.821     0.875000        43751         8.00
       1.854     0.887500        44371         8.89
       1.891     0.900000        45001        10.00
       1.929     0.912500        45619        11.43
       1.976     0.925000        46249        13.33
       2.031     0.937500        46885        16.00
       2.061     0.943750        47184        17.78
       2.091     0.950000        47502        20.00
       2.129     0.956250        47818        22.86
       2.177     0.962500        48127        26.67
       2.229     0.968750        48445        32.00
       2.255     0.971875        48596        35.56
       2.287     0.975000        48745        40.00
       2.321     0.978125        48902        45.71
       2.357     0.981250        49059        53.33
       2.391     0.984375        49217        64.00
       2.409     0.985938        49293        71.11
       2.433     0.987500        49369        80.00
       2.465     0.989062        49448        91.43
       2.499     0.990625        49527       106.67
       2.535     0.992188        49606       128.00
       2.563     0.992969        49648       142.22
       2.585     0.993750        49682       160.00
       2.609     0.994531        49721       182.86
       2.647     0.995313        49761       213.33
       2.681     0.996094        49800       256.00
       2.695     0.996484        49818       284.44
       2.713     0.996875        49837       320.00
       2.747     0.997266        49858       365.71
       2.775     0.997656        49877       426.67
       2.817     0.998047        49896       512.00
       2.843     0.998242        49906       568.89
       2.901     0.998437        49915       640.00
       2.953     0.998633        49925       731.43
       3.023     0.998828        49935       853.33
       3.135     0.999023        49945      1024.00
       3.189     0.999121        49950      1137.78
       3.229     0.999219        49954      1280.00
       3.353     0.999316        49959      1462.86
       3.677     0.999414        49964      1706.67
       3.859     0.999512        49969      2048.00
       3.907     0.999561        49972      2275.56
       4.041     0.999609        49974      2560.00
       4.119     0.999658        49976      2925.71
       4.395     0.999707        49979      3413.33
       4.523     0.999756        49981      4096.00
       4.723     0.999780        49983      4551.11
       5.503     0.999805        49984      5120.00
       5.511     0.999829        49985      5851.43
       6.351     0.999854        49986      6826.67
       7.163     0.999878        49987      8192.00
       7.967     0.999890        49988      9102.22
       8.791     0.999902        49989     10240.00
       8.791     0.999915        49989     11702.86
       9.615     0.999927        49990     13653.33
       9.615     0.999939        49990     16384.00
      10.439     0.999945        49991     18204.44
      10.439     0.999951        49991     20480.00
      10.439     0.999957        49991     23405.71
      11.255     0.999963        49992     27306.67
      11.255     0.999969        49992     32768.00
      11.255     0.999973        49992     36408.89
      11.255     0.999976        49992     40960.00
      11.255     0.999979        49992     46811.43
      12.039     0.999982        49993     54613.33
      12.039     1.000000        49993          inf
#[Mean    =        1.236, StdDeviation   =        0.523]
#[Max     =       12.032, Total count    =        49993]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  59999 requests in 1.00m, 4.16MB read
Requests/sec:    999.99
Transfer/sec:     70.94KB
```

По результатам нагрузочного тестирования
видно, что 75% приходящих запросов обрабатываются
в промежуток до 1.59мс,
99% — до 2.48мс, 99.999% — до 12.04мс,
максимальное время обрабоки запроса до 12.04мс.

### Профилирование с помощью async-profiler

Произведём профилирование использования процессорного времени и 
запросов выделения памяти.

#### При обработке PUT запросов: 

[put_cpu.html](put_cpu.html) </br>
[put_mem.html](put_mem.html)

По результатам профилирования CPU видно, что большую
часть процессорного времени (52.76%) занимает запись в сокет,
затем 11.06% процессорного времени уходит на чтение из сокета.
В нашей реализации большую часть времени занимает метод 
`LsmDao.upsert()` — 6.03%.

По результата профилирования alloc видно, что большая часть
аллокаций происходит при обработке HTTP запросов
(преобразование параметров запроса и ответа).
В нашей реализации сервиса большая часть аллокаций происходит
при создании
копий `HeapByteBufferR` — 16.34%.


#### При обработке GET запросов:

[get_cpu.html](get_cpu.html) </br>
[get_mem.html](put_mem.html)

По результатам профилирования CPU видно, что большую
часть процессорного времени (47.65%) занимает запись в сокет,
затем 10.07% процессорного времени уходит на чтение из сокета.
В нашей реализации большую часть времени занимает метод
`LsmDao.range()` — 2.24%.

По результата профилирования alloc видно, что большая часть
аллокаций происходит при обработке HTTP запросов
(преобразование параметров запроса и ответа).
В нашей реализации сервиса большая часть аллокаций происходит
внутри метода
`LsmDao.range()` — 29.63%.